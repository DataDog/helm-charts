---
# Source: datadog/templates/datadog-agent.yaml
apiVersion: datadoghq.com/v2alpha1
kind: DatadogAgent
metadata:
  name: datadog
  namespace: default
spec:
  global:
    clusterName: migration-poc1
    logLevel: INFO
    originDetectionUnified:
      enabled: false
    kubelet:
      host:
        fieldRef:
          fieldPath: status.hostIP
      podResourcesSocketPath: /var/lib/kubelet/pod-resources

    credentials:
      apiSecret:
        secretName: "datadog-secret"
        keyName: api-key
      appSecret:
        secretName: "datadog-secret"
        keyName: app-key
    localService:
      forceEnableLocalService: false
    networkPolicy:
      create: false
      flavor: kubernetes
      dnsSelectorEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s:k8s-app: kube-dns
    fips:
      enabled: false
      port: 9803
      portRange: 15
      useHTTPS: false
      localAddress: 127.0.0.1
      image:
        name: fips-proxy
        tag: 1.1.16
  features:
    externalMetricsServer:
      enabled: false
      registerAPIService: true
      port: 8443
      useDatadogMetrics: false
      wpaController: false
    prometheusScrape:
      enabled: false
      enableServiceEndpoints: false
      version: 2
    helmCheck:
      enabled: false
      collectEvents: false
    cspm:
      enabled: true
      checkInterval: 20m
      hostBenchmarks:
        enabled: true
    cws:
      enabled: false
      syscallMonitorEnabled: false
      network:
        enabled: true
      securityProfiles:
        enabled: true
    apm:
      enabled: true
      hostPortConfig:
        enabled: false
        hostPort: 8126
      unixDomainSocketConfig:
        path: /var/run/datadog/
      errorTrackingStandalone:
        enabled: false
      instrumentation:
        enabled: false
    admissionController:
      enabled: true
      cwsInstrumentation:
        enabled: false
        mode: remote_copy
      failurePolicy: Ignore
      kubernetesAdmissionEvents:
        enabled: false
      mutateUnlabelled: false
      mutation:
        enabled: true
      validation:
        enabled: true
      webhookName: datadog-webhook
      agentSidecarInjection:
        enabled: false
        clusterAgentCommunicationEnabled: true
    controlPlaneMonitoring:
      enabled: true
    eventCollection:
      collectKubernetesEvents: true
      collectedEventTypes:
        - kind: Pod
          reasons:
          - Failed
          - BackOff
          - Unhealthy
          - FailedScheduling
          - FailedMount
          - FailedAttachVolume
        - kind: Node
          reasons:
          - TerminatingEvictedPod
          - NodeNotReady
          - Rebooted
          - HostPortConflict
        - kind: CronJob
          reasons:
          - SawCompletedJob
      unbundleEvents: false
    kubeStateMetricsCore:
      enabled: true
    orchestratorExplorer:
      enabled: true
      scrubContainers: true
    clusterChecks:
      enabled: true
      useClusterChecksRunners: true
    remoteConfiguration:
      enabled: true
    dogstatsd:
      originDetectionEnabled: false
      hostPortConfig:
        enabled: false
        hostPort: 8125
      unixDomainSocketConfig:
        enabled: true
        path: /var/run/datadog/dsd.socket
      tagCardinality: low
    logCollection:
      enabled: false
      containerCollectAll: false
      containerCollectUsingFiles: true
    npm:
      enabled: false
      enableConntrack: true
      collectDNSStats: true
    usm:
      enabled: false
    gpu:
      enabled: false
      requiredRuntimeClassName: nvidia
    processDiscovery:
      enabled: true
    liveProcessCollection:
      stripProcessArguments: false
    oomKill:
      enabled: false
    tcpQueueLength:
      enabled: false
    sbom:
      containerImage:
        enabled: false
        overlayFSDirectScan: false
      host:
        enabled: false
    otlp:
      receiver:
        protocols:
          grpc:
            enabled: false
            endpoint: 0.0.0.0:4317
          http:
            enabled: false
            endpoint: 0.0.0.0:4318
    otelCollector:
      enabled: false
      ports:
        - containerPort: 4317
          name: otel-grpc
          protocol: TCP
        - containerPort: 4318
          name: otel-http
          protocol: TCP
  override:
    nodeAgent:
      containers:
        agent:
          readinessProbe:
            failureThreshold: 6
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
        trace-agent:
          livenessProbe:
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5
      env:
        - name: DD_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
      hostPID: true
      image:
        name: agent
        pullPolicy: IfNotPresent
        tag: 7.69.3
      createRbac: true
      serviceAccountName: default
      updateStrategy:
        rollingUpdate:
          maxUnavailable: 10%
        type: RollingUpdate
      hostNetwork: false
    clusterAgent:
      containers:
        cluster-agent:
          healthPort: 5556
          livenessProbe:
            failureThreshold: 6
            httpGet:
              path: /live
              port: 5556
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 6
            httpGet:
              path: /ready
              port: 5556
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
          startupProbe:
            failureThreshold: 6
            httpGet:
              path: /startup
              port: 5556
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
      image:
        name: cluster-agent
        pullPolicy: IfNotPresent
        tag: 7.69.3
      createRbac: true
      serviceAccountName: default
      replicas: 2
      updateStrategy:
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
        type: RollingUpdate
      hostNetwork: false
    clusterChecksRunner:
      containers:
        agent:
          healthPort: 5557
          livenessProbe:
            failureThreshold: 6
            httpGet:
              path: /live
              port: 5557
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 6
            httpGet:
              path: /ready
              port: 5557
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
          startupProbe:
            failureThreshold: 6
            httpGet:
              path: /startup
              port: 5557
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 15
            successThreshold: 1
            timeoutSeconds: 5
      image:
        name: agent
        pullPolicy: IfNotPresent
        tag: 7.69.3
      createRbac: true
      serviceAccountName: default
      replicas: 2
      updateStrategy:
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
        type: RollingUpdate
